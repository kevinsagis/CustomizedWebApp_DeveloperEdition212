/**
 * Copyright @ 2019 Esri.
 * All rights reserved under the copyright laws of the United States and applicable international laws, treaties, and conventions.
 */
define(["esri/core/declare","esri/geometry/support/centroid","esri/views/3d/support/PromiseLightweight","esri/views/3d/layers/graphics/Graphics3DSymbolCommonCode","esri/core/libs/earcut/earcut","esri/core/libs/gl-matrix-2/vec3f64","esri/core/libs/gl-matrix-2/vec3","../../support/geometryUtils"],function(t,e,n,i,r,p,s,a){var o=p.vec3f64,s=s.vec3,d=o.create(),h=o.create(),c=o.create(),u=o.create(),x=o.create(),l=o.create(),f=o.create(),g=o.create(),v=6378137,m={Down:0,Up:1},y=Math.cos(5*(Math.PI/180)),b=100.11,_=t(n["default"]||n.PromiseLightweight,{constructor:function(t,n,r){var p=t.geometry.rings,s={rings:p,hasZ:!1};this.center=e.polygonCentroid(s),this._geometryData=i.copyPathData(p,t.geometry.hasZ),this._geometryData&&n>=0&&r>=0?(this.index=n,this.stride=r,this.resolve()):this.reject()},createBuffers:function(t,e){var n,p,s,o,d,h,c,u,x=this._geometryData.polygons,l=[],f=this._geometryData.vertexData;if(!f)return l;var g=f.length/3,v=new Float64Array(f.length);i.reproject(f,0,t,v,0,e,g);for(var y=new Float64Array(v),_=0;_<x.length;++_){n=x[_],c=n.count,u=n.index;var w=new Float64Array(f.buffer,3*u*f.BYTES_PER_ELEMENT,3*c);if(p=n.holeIndices.map(function(t){return t-u}),s=r(w,p,3),!(s.length<1)){var D={polygonIndex:_},E=new Float64Array(y.buffer,3*u*y.BYTES_PER_ELEMENT,3*c),z=this._computeNormalAndDistance(E);D.dist=z.distance;var A=a.getOrigin(v,g,u,c);if(A){D.origin=A;var N=[],U=[];o=n.count,d=2*o;for(var M=0;M<o;M++)h=M*this.stride,N[0+h]=w[0+3*M],N[1+h]=w[1+3*M],N[2+h]=1,N[3+h]=this.index,N[4+h]=m.Down,N[5+h]=this.center[0],N[6+h]=this.center[1],h=(M+o)*this.stride,N[0+h]=w[0+3*M],N[1+h]=w[1+3*M],N[2+h]=b,N[3+h]=this.index,N[4+h]=m.Up,N[5+h]=this.center[0],N[6+h]=this.center[1];for(var F=0,L=0,P=0;P<n.pathLengths.length;P++){L=n.pathLengths[P];for(var S=0;S<L;S++)S!==L-1?U.push(S+1+F,S+F,S+1+o+F,S+1+o+F,S+F,S+o+F):U.push(0+F,S+F,0+o+F,0+o+F,S+F,S+o+F);F+=L}this._subdivision2(w,E,s,o,N,U),D.indexNums=U.length,D.vertexNum=N.length/this.stride,D.vertices=new Float32Array(N),D.indices=new Uint32Array(U),l.push(D)}}}return l},_computeNormalAndDistance:function(t){var e=0,n=3,i=6;s.set(d,t[e++],t[e++],t[e++]),s.set(h,t[n++],t[n++],t[n++]),s.set(c,t[i++],t[i++],t[i++]),s.subtract(u,d,h),s.subtract(x,c,h);var r=o.create();s.cross(r,u,x),s.normalize(r,r);var p=Math.abs(s.dot(r,d)),a=v-p,l=s.normalize(d,d),f=s.dot(r,l),g=Math.abs(a/f);return{normal:r,distance:g}},_subdivision:function(t,e,n,i,r,p){for(var s,a,o,d,h,c,u,x,l=e.length/3,f=0,g=0,v=0;v<l;v++)d=e[f++],h=e[f++],c=e[f++],s=3*d,a=3*h,o=3*c,u=(t[s]+t[a]+t[o])/3,x=(t[s+1]+t[a+1]+t[o+1])/3,r.push(u,x,b,this.index,m.Up,this.center[0],this.center[1]),p.push(d+n,h+n,i+g),p.push(h+n,c+n,i+g),p.push(c+n,d+n,i+g),g++},_doSubdivision:function(t,e,n){if(t.length>0)for(var i,r,p,a,d,h,c,u,x,v,_=-1,w=e.length/this.stride;null!=(i=t.pop());)if(s.copy(l,i.pt0),s.copy(f,i.pt1),s.copy(g,i.pt2),i.n0||(i.n0=o.create(),s.normalize(i.n0,l)),i.n1||(i.n1=o.create(),s.normalize(i.n1,f)),i.n2||(i.n2=o.create(),s.normalize(i.n2,g)),r=s.dot(i.n0,i.n1),p=s.dot(i.n1,i.n2),a=s.dot(i.n0,i.n2),r<y||p<y||a<y){if(d=Math.min(r,p,a),!isNaN(d)&&null!=d)if(d==r){_++,h=.5*(l[0]+f[0]),c=.5*(l[1]+f[1]),u=.5*(l[2]+f[2]),x=.5*(i.pt00[0]+i.pt11[0]),v=.5*(i.pt00[1]+i.pt11[1]);var D=o.fromValues(h,c,u);s.normalize(D,D),t.push({pt0:i.pt0,pt1:[h,c,u],pt2:i.pt2,pt00:i.pt00,pt11:[x,v],pt22:i.pt22,index0:i.index0,index1:w+_,index2:i.index2,n0:i.n0,n1:D,n2:i.n2}),t.push({pt0:[h,c,u],pt1:i.pt1,pt2:i.pt2,pt00:[x,v],pt11:i.pt11,pt22:i.pt22,index0:w+_,index1:i.index1,index2:i.index2,n0:D,n1:i.n1,n2:i.n2}),e.push(x,v,b,this.index,m.Up,this.center[0],this.center[1]),n.push(w+_,i.index0,i.index1)}else if(d==p){_++,h=.5*(f[0]+g[0]),c=.5*(f[1]+g[1]),u=.5*(f[2]+g[2]),x=.5*(i.pt22[0]+i.pt11[0]),v=.5*(i.pt22[1]+i.pt11[1]);var D=o.fromValues(h,c,u);s.normalize(D,D),t.push({pt0:i.pt0,pt1:i.pt1,pt2:[h,c,u],pt00:i.pt00,pt11:i.pt11,pt22:[x,v],index0:i.index0,index1:i.index1,index2:w+_,n0:i.n0,n1:i.n1,n2:D}),t.push({pt0:i.pt0,pt1:[h,c,u],pt2:i.pt2,pt00:i.pt00,pt11:[x,v],pt22:i.pt22,index0:i.index0,index1:w+_,index2:i.index2,n0:i.n0,n1:D,n2:i.n2}),e.push(x,v,b,this.index,m.Up,this.center[0],this.center[1]),n.push(w+_,i.index1,i.index2)}else if(d==a){_++,h=.5*(l[0]+g[0]),c=.5*(l[1]+g[1]),u=.5*(l[2]+g[2]),x=.5*(i.pt22[0]+i.pt00[0]),v=.5*(i.pt22[1]+i.pt00[1]);var D=o.fromValues(h,c,u);s.normalize(D,D),t.push({pt0:i.pt0,pt1:i.pt1,pt2:[h,c,u],pt00:i.pt00,pt11:i.pt11,pt22:[x,v],index0:i.index0,index1:i.index1,index2:w+_,n0:i.n0,n1:i.n1,n2:D}),t.push({pt0:[h,c,u],pt1:i.pt1,pt2:i.pt2,pt00:[x,v],pt11:i.pt11,pt22:i.pt22,index0:w+_,index1:i.index1,index2:i.index2,n0:D,n1:i.n1,n2:i.n2}),e.push(x,v,b,this.index,m.Up,this.center[0],this.center[1]),n.push(w+_,i.index2,i.index0)}}else n.push(i.index0,i.index1,i.index2)},_subdivision2:function(t,e,n,i,r,p){for(var s,a,o,d,h,c,u=n.length/3,x=0,l=0;l<u;l++)d=n[x++],h=n[x++],c=n[x++],s=3*d,a=3*h,o=3*c,this._doSubdivision([{pt0:[e[s],e[s+1],e[s+2]],pt1:[e[a],e[a+1],e[a+2]],pt2:[e[o],e[o+1],e[o+2]],pt00:[t[s],t[s+1]],pt11:[t[a],t[a+1]],pt22:[t[o],t[o+1]],index0:d+i,index1:h+i,index2:c+i}],r,p)},destroy:function(){this.isFulfilled()||this.reject()}});return _});